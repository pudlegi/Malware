# Anatomy of native IIS malware

ESET 연구원은 인터넷 정보 서비스 (IIS) 웹 서버 소프트웨어 에 대한 악성 확장으로 구현된 이전에 문서화되지 않은 일련의 악성 프로그램을 발견했습니다. 인터넷 정보 서비스 (IIS)는 확장 가능한 모듈식 아키텍처를 사용하는 Windows용 Microsoft 웹 서버 소프트웨어입니다. 위협 행위자가 이 확장성을 오용하여 네트워크 트래픽을 가로채거나 수정하는 것은 잘 알려져 있지 않습니다. 발견된 악성코드는 정부의 우편함과 전자 상거래를 대상으로 하고 malware 배포를 지원하는 이 다양한 유형의 위협은 서버 통신을 도청하고 변조하여 작동합니다. 전자 상거래 사이트의 지불 정보를 대상으로 하는 IIS 맬웨어의 첫 번째 알려진 사례는 2013년에 보고되었습니다.

새로 발견된 패밀리에 대한 완전한 분석과 함께 당사의 새로운 문서인 Anatomy of native IIS Malware 는 동료 보안 연구원과 방어자가 이러한 종류의 서버 측 위협을 탐지, 분석 및 완화하는 데 도움이 되는 포괄적인 가이드를 제공합니다. 이 문서에서는 백서의 결과를 요약합니다.

## How IIS malware works
IIS 맬웨어는 사이버 범죄, 사이버 스파이 활동 및 SEO 사기에 사용되는 다양한 종류의 위협이지만 모든 경우에 주요 목적은 손상된 IIS 서버로 들어오는 HTTP 요청을 가로채서 서버가 이러한 요청(일부)에 응답하는 방식에 영향을 미치는 것입니다.

기본 설치를 사용하면 IIS 자체가 영구적이므로 추가 지속성 메커니즘을 구현하기 위해 확장 기반 IIS 맬웨어가 필요하지 않습니다. IIS 확장으로 구성된 악성 IIS 모듈은 IIS 작업자 프로세스( w3wp.exe )에 의해 로드되어 서버로 전송된 요청을 처리합니다. 여기에서 IIS 맬웨어가 요청 처리를 방해할 수 있습니다.

<img width="625" alt="Overview of IIS malware mechanisms" src="https://user-images.githubusercontent.com/82322413/179432677-050df4a3-6434-4acd-a34f-561ce8d67e10.png">

### Five main modes in which IIS malware operates

- IIS 백도어 를 통해 운영자는 IIS가 설치된 손상된 컴퓨터를 원격으로 제어할 수 있습니다.
- IIS 정보 스틸러 를 사용하면 운영자가 손상된 서버와 합법적인 방문자 사이의 일반 트래픽을 가로채 로그인 자격 증명 및 지불 정보와 같은 정보를 훔칠 수 있습니다. IIS 맬웨어가 서버에서 처리하는 모든 데이터에 액세스할 수 있기 때문에 HTTPS를 사용해도 이 공격이 방지되지 않습니다. 서버는 데이터가 암호화되지 않은 상태로 처리되는 곳입니다.
- IIS 인젝터 는 악성 콘텐츠를 제공하기 위해 합법적인 방문자에게 전송된 HTTP 응답을 수정합니다.
- IIS 프록시 는 손상된 서버를 다른 맬웨어 제품군에 대한 C&C 인프라의 무의식적 부분으로 전환하고 IIS 서버를 오용하여 해당 맬웨어의 피해자와 실제 C&C 서버 간의 통신을 중계합니다.
- SEO 사기 IIS 맬웨어 는 검색 엔진에 제공되는 콘텐츠를 수정하여 SERP 알고리즘을 조작하고 공격자가 관심 있는 다른 웹사이트의 순위를 높입니다.

## How and where it spreads

기본 IIS 모듈은 서버 작업자 프로세스에서 사용할 수 있는 모든 리소스에 제한 없이 액세스할 수 있으므로 기본 IIS 맬웨어를 설치하려면 관리 권한이 필요합니다. 이는 초기 공격 벡터에 대한 옵션을 상당히 좁힙니다. 우리는 두 가지 시나리오에 대한 증거를 보았습니다.
- 합법적인 IIS 모듈의 트로이 목마 버전으로 확산되는 IIS 맬웨어
- 서버 악용을 통해 확산되는 IIS 악성코드

예를 들어, 2021년 3월과 6월 사이에 Microsoft Exchange 사전 인증 RCE 취약성 체인( CVE-2021-26855 , CVE-2021-26857 , CVE-2021-26858 및 CVE-2021 )을 통해 확산되는 IIS 백도어의 물결을 감지했습니다. -27065 ), 일명 ProxyLogon. 특히 OWA를 구현하는 데 IIS가 사용 되므로 웹용 Outlook (OWA)이 활성화 된 Exchange 서버가 표적이 되었습니다. 이 서버 는 특히 스파이 활동의 대상이었습니다.
동료들이 2021년 3월에 이러한 사례를 처음 보고 한 후 동일한 취약점을 통해 Microsoft Exchange 서버로 확산되는 다양한 IIS 백도어 캠페인을 4개 더 감지했습니다. 우리의 원격 측정을 보완하기 위해 우리는 이러한 백도어의 존재를 감지하기 위해 인터넷 전체에서 스캔을 수행하여 멀웨어의 다른 피해자를 식별하고 알릴 수 있었습니다.

<img width="685" alt="Victims of native IIS modules spread via the ProxyLogon vulnerability chain" src="https://user-images.githubusercontent.com/82322413/179433027-2fb634ee-b846-4b72-8c44-5cdf0d487e3c.png">
위 그림은 원격 측정 및 인터넷 전체 스캔 데이터를 사용하여 이러한 5가지 캠페인의 영향을 받는 서버의 자리적 위치를 보여줍니다. 희생자 중에는 다음과 같은 단체가 있었습니다.

- 동남아 3개국 정부기관
- 캄보디아의 주요 통신 회사
- 베트남 연구기관
- 주로 캐나다, 배트남, 인도, 미국, 뉴질랜드, 한국 및 기타 국가에 위치한 다양한 사업 분야의 수십 개의 민간 기업

IIS 백도어는 유명 사서함을 감시하는 데 적합할 수 있지만 IIS 맬웨어의 피해자는 손상된 서버에 국한되지 않습니다. 방문자로부터 중요한 데이터를 훔치거나(IIS infostealers) 악성 콘텐츠를 제공합니다(IIS injectors).

## The insides of native IIS malware
기술적인 관점에서 볼 때 모든 유형의 기본 IIS 맬웨어는 IIS C++ API 를 사용하여 작성된 DLL(동적 연결 라이브러리)로 구현됩니다. 이러한 DLL은 다음을 수행해야 합니다.
<img width="542" alt="A typical RegisterModule function of a native IIS module" src="https://user-images.githubusercontent.com/82322413/179433280-dec11f38-a53c-418d-8e3e-b42dc1f842d9.png">

- CHttpModule 또는 CGlobalModule 클래스(또는 둘 다) 에서 상속된 클래스를 구현하고 해당 클래스의 여러 메서드( 이벤트 처리기 ) 를 재정의합니다.
- 라이브러리 진입점인 RegisterModule 함수를 내 보냅니다. 이 함수 는 그림 3과 같이 이러한 클래스의 인스턴스를 만들고 구현된 서버 이벤트 처리기를 등록하는 역할을 합니다.

<img width="520" alt="HTTP request-processing pipeline in IIS" src="https://user-images.githubusercontent.com/82322413/179433435-06d74893-a372-4d2f-8290-71fa1e1c3a39.png">
서버 이벤트는 IIS 서버가 요청을 처리하는 동안 취하는 단계뿐만 아니라 HTTP 응답 전송과 같은 서버가 취하는 다른 작업도 참조합니다. 이러한 이벤트는 서버 모듈에 구현된 이벤트 핸들러에 의해 처리되는 이벤트 알림을 생성합니다.
<img width="659" alt="Module class methods of CHttpModule class (left) and CGlobalModule class (right)" src="https://user-images.githubusercontent.com/82322413/179433477-c80cfdcc-6d33-49c3-950a-693c79c42049.png">

## Network communication
IIS 맬웨어의 주목할만한 기능은 운영자와 통신하는 방법입니다. 악성 IIS 모듈, 특히 IIS 백도어는 일반적으로 C&C 서버에 대한 새로운 연결을 생성하지 않습니다. 공격자가 감염된 IIS 웹 서버로 보내는 HTTP 요청에 일부 "비밀"을 제공하여 공격자가 이를 제어할 수 있도록 하는 수동 임플란트 로 작동 합니다. 그렇기 때문에 IIS 백도어는 일반적으로 서버를 제어하는데 사용되며 다음과 같이 미리 정의된 구조를 갖는 공격자 요청 을 인식하는 메커니즘을 가지고 있습니다.

- 특정 정규식과 일치하는 URL 또는 요청 본문
- 특정 사용자 정의 HTTP 헤더가 있음
- 하드코딩된 비밀번호와 일치하는 포함된 토큰(URL, 요청 본문 또는 헤더 중 하나)
- 하드코딩된 값과 일치하는 임베디드 토큰의 해시 값
- 더 복잡한 조건 – 예를 들어 위의 모든 항목 간의 관계

반면에 일부 IIS 맬웨어 범주 는 HTTP 또는 DNS와 같은 프로토콜을 사용하여 대체 C&C 채널을 구현하여 즉석에서 현재 구성을 가져옵니다. 예를 들어, IIS 인젝터는 손상된 웹사이트의 합법적인 방문자로부터 새로운 요청이 있을 때마다 C&C 서버에 접속하고 서버 응답을 사용하여 해당 방문자에게 제공된 콘텐츠(예: 악성 코드 또는 애드웨어)를 수정합니다.

## Mitigation
기본 IIS 모듈은 관리자 권한으로만 설치할 수 있으므로 공격자는 먼저 IIS 서버에 대한 높은 액세스 권한을 얻어야 합니다. 다음 권장 사항은 작업을 더 어렵게 만드는 데 도움이 될 수 있습니다.

- IIS 서버 관리를 위해 강력하고 고유한 암호가 있는 전용 계정을 사용하십시오. 이러한 계정에 대해 다단계 인증(MFA)이 필요합니다. 이러한 계정의 사용을 모니터링합니다.
- 정기적으로 OS를 패치하고 인터넷에 노출되는 서비스를 신중하게 고려하여 서버 악용의 위험을 줄이십시오.
- IIS 서버에서 웹 응용 프로그램 방화벽 및/또는 끝점 보안 솔루션을 사용하는 것을 고려하십시오.
- 기본 IIS 모듈은 서버 작업자 프로세스에서 사용할 수 있는 모든 리소스에 제한 없이 액세스할 수 있습니다. 트로이 목마 버전을 다운로드하지 않으려면 신뢰할 수 있는 출처의 기본 IIS 모듈만 설치해야 합니다. 마법처럼 SEO를 향상시키는 것과 같은 너무 좋은 기능을 약속하는 모듈에 특히 유의하십시오.
- IIS 서버 구성을 정기적으로 확인하여 설치된 모든 기본 모듈이 합법적인지(신뢰할 수 있는 공급자가 서명했거나 의도적으로 설치했는지) 확인합니다.

## Conclusion
인터넷 정보 서비스 웹 서버는 사이버 범죄와 사이버 스파이 활동을 위해 다양한 악의적인 행위자의 표적이 되었습니다. 웹 개발자에게 확장성을 제공하도록 설계된 소프트웨어의 모듈식 아키텍처는 공격자가 IIS 서버의 일부가 되어 트래픽을 가로채거나 수정하는 데 유용한 도구가 될 수 있습니다

끝점(및 기타) 보안 소프트웨어가 IIS 서버에서 실행되는 경우는 여전히 매우 드물기 때문에 공격자가 오랫동안 눈에 띄지 않게 작동하기 쉽습니다. 이것은 인증 및 지불 정보를 포함하여 방문자의 데이터를 보호하려는 모든 심각한 웹 포털에 방해가 될 것입니다. OWA를 사용하는 조직은 IIS에 의존하고 스파이 활동의 흥미로운 대상이 될 수 있으므로 주의를 기울여야 합니다.

IIS 서버 위협이 기본 IIS 맬웨어에 국한되지는 않지만, 우리는 이 백서가 방어자가 IIS 위협을 이해, 식별 및 제거하는 데 도움이 되는 출발점이 될 것이며, 그들의 일반적인 전술, 기술 및 절차가 동료 연구원들이 이러한 종류의 위협을 리버스 엔지니어링하고 이해하는 데 도움이 될 것이라고 믿습니다.
